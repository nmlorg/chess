<!DOCTYPE html>

<body>

<script type="module">
import {fixAssert} from './assert.js';


let testfiles = [
    'assert_test.js',
    'estree_test.js',
    'test_test.js',
    'game/board_test.js',
    'game/pieces_test.js',
];


class AssertionError extends Error {}


let utils = {

AssertionError,

assert(assertion, msg) {
  if (assertion)
    return;
  let message = 'Assertion failed';
  if (msg)
    message = `${message}: ${msg}`;
  throw new AssertionError(message);
},

format(obj) {
  let str, typeofobj = typeof obj;
  if ((typeofobj == 'string') || (typeofobj == 'number') || (typeofobj == 'boolean'))
    str = JSON.stringify(obj);
  else {
    str = String(obj).replace(/\n\s*/g, ' ');
    if (str == '[object Object]') {
      str = '{' + Object.entries(obj).map(([k, v]) => `${k}: ${this.format(v)}`).join(', ') + '}';
      if ((typeofobj == 'object') && (obj.constructor.name != 'Object'))
        str = `${obj.constructor.name}(${str})`;
    }
  }
  if (str.length > 60)
    str = str.substr(0, 59) + '\u22ef';
  return str;
},

};


let pre = document.body.appendChild(document.createElement('pre'));

for (let testfilename of testfiles) {
  let content = await fetch(testfilename).then(response => response.text());
  let base = new URL(testfilename, document.baseURI).href;
  content = `\n${content}`.replaceAll(
      /(\nimport .*')([^']*)(';)/g,
      (match, first, path, last) => `${first}${new URL(path, base).href}${last}`).substr(1);
  content = content.replaceAll(/ assert ([^;]*);/g, (match, expr) => ` {${fixAssert(expr)}}`);
  let blob = new Blob([content], {type: 'text/javascript'});
  let bloburl = URL.createObjectURL(blob);
  let testfile = await import(bloburl);
  URL.revokeObjectURL(bloburl);
  for (let [funcname, func] of Object.entries(testfile)) {
    if (funcname.match(/^test/) && (func instanceof Function)) {
      pre.append(`${testfilename}:${funcname}`);
      try {
        func(utils);
        pre.append(' PASS\n');
      } catch (exc) {
        pre.append(' FAIL\n');
        pre.append(`${exc.stack}\n`);
      }
    }
  }
}
</script>
